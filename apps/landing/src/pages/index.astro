---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Hero from "../components/hero";
import World from "../components/World";
import Factions from "../components/Factions";
import System from "../components/System";
import Footer from "../components/Footer.astro";
import "../styles/global.css";
---

<BaseLayout>
  <Header />
  <main>
    <Hero client:load />
    <section id="after-hero" class="after-hero-locked">
      <div id="after-hero-start">
        <World client:load />
      </div>
      <Factions client:load />
      <System client:load />
    </section>
  </main>
  <Footer />
</BaseLayout>

<script is:inline>
  const HERO_STORAGE_KEY = "solaris:hero-completed";
  const HERO_EXPIRY_MS = 7 * 24 * 60 * 60 * 1000;

  const shouldForceHeroDone = () => {
    if (window.__SOLARIS_HERO_DONE) return true;
    if (new URLSearchParams(window.location.search).has("skip")) return true;

    try {
      const raw = localStorage.getItem(HERO_STORAGE_KEY);
      if (!raw) return false;
      const timestamp = Number.parseInt(raw, 10);
      return Number.isFinite(timestamp) && Date.now() - timestamp < HERO_EXPIRY_MS;
    } catch {
      return false;
    }
  };

  const unlockAfterHero = () => {
    const afterHero = document.getElementById("after-hero");
    const anchor = document.getElementById("after-hero-start");
    if (!afterHero) return;
    afterHero.classList.remove("after-hero-locked");
    afterHero.classList.add("after-hero-unlocked");
    if (anchor) {
      requestAnimationFrame(() => {
        anchor.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }
  };

  if (shouldForceHeroDone()) {
    unlockAfterHero();
  }

  window.addEventListener("solaris:hero-done", unlockAfterHero, { once: true });
</script>
