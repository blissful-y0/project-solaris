# 심플 전투 경합 처리 계획서 (No Critical)

> 작성일: 2026-02-18  
> 범위: AI GM 전투 경합의 최소 기능(MVP) 운영 모델  
> 목표: 계산 신뢰성 우선 + 구현 복잡도 최소화

## 1. 목표와 전제

### 목표
- 전투 경합을 **일관된 수치 규칙**으로 처리한다.
- 서사 품질은 유지하되, 계산 오류 가능성을 최소화한다.
- 운영자가 빠르게 디버깅 가능한 구조로 시작한다.

### 전제
- 판정 등급은 3단계만 사용: `Success`, `Partial`, `Fail`
- `Critical`, `Critical Failure`는 초기 버전에서 제외
- LLM은 산술 연산을 수행하지 않는다
- 최종 수치 변경은 서버 고정 규칙으로만 결정한다
- 행동 선언 시 능력 코스트는 성공/실패와 무관하게 선차감한다

## 2. 비범위(이번 단계에서 하지 않는 것)
- 크리티컬/자해/역효과 규칙
- 복잡한 확률 공식, 가중치 자동학습
- 다중 라운드 콤보 보정
- 시즌별 동적 밸런스 자동 조정

## 3. 처리 플로우 (비동시 협의형)

1. **Input 수집**
- A가 행동 선언 1개 제출(`action_type`, `target_stat`, `declaration`, `ability_id`)
- B는 A의 선언을 확인한 뒤 자신의 행동 선언 1개 제출
- 행동 선언 시 참조할 `ability_id`를 함께 제출
- 현재 스탯 스냅샷 저장
- **Input 단계 선검증**:
  - `ability_id`로 능력 데이터를 조회한다
  - `current_hp >= ability.cost_hp` 및 `current_will >= ability.cost_will`를 검사한다
  - 부족하면 즉시 제출 거부(`코스트 부족`)하고 Judgement 단계로 넘기지 않는다

2. **양측 확인(Lock)**
- A/B가 서로의 선언을 확인하면 턴을 `locked` 상태로 고정한다
- `locked` 이전에는 선언 수정 허용, `locked` 이후에는 수정 불가
- 제한 시간 내 상대 선언이 없으면 시스템 정책에 따라:
  - 자동 `Fail` 처리 또는
  - 해당 턴 무효 처리

3. **Judgement 산출**
- LLM 또는 룰 평가기로 행동 성공도 판정
- 출력은 반드시 `Success/Partial/Fail` 중 하나
- 숫자 결과(최종 데미지)는 출력하지 않음

4. **Execution 계산**
- 서버 룰로 `multiplier` 매핑
  - `Success = 1.0`
  - `Partial = 0.5`
  - `Fail = 0.0`
- 능력 코스트 차감(선차감):
  - `new_hp = max(0, current_hp - ability.cost_hp)`
  - `new_will = max(0, current_will - ability.cost_will)`
  - 코스트 부족 검증은 Input 단계에서 이미 완료되었음을 전제한다
- `final_damage = floor(base_damage * multiplier)`
- `new_value = max(0, current - final_damage)`
- `locked`된 양측 선언을 기준으로 단일 트랜잭션 반영

5. **Narration 생성**
- 확정 수치 기반으로 결과 서사 생성
- 서사는 수치를 변경하지 못함

## 4. 규칙 테이블 초안

### 판정 등급
| Grade | Multiplier | 의미 |
|---|---:|---|
| Success | 1.0 | 의도 대부분 달성 |
| Partial | 0.5 | 부분 달성 |
| Fail | 0.0 | 효과 없음 |

### 기본 데미지(초안)
| action_type | target_stat | base_damage(기본기) |
|---|---|---:|
| attack | HP | 20 |
| disrupt | WILL | 15 |
| disrupt | RESOURCE | 15 |
| defend | - | 0 |
| support | - | 0 |

### 능력 등급별 base_damage 계수
| ability_tier | damage_factor |
|---|---:|
| basic | 1.0 |
| mid | 1.5 |
| advanced | 2.2 |

최종 계산:
`base_damage_final = floor(base_damage(action_type, target_stat) * damage_factor(ability_tier))`

### 행동 코스트 참조 규칙
- 코스트는 tier 고정표를 사용하지 않는다.
- 코스트는 캐릭터별 능력 레코드에서 직접 참조한다:
  - `ability.cost_hp`
  - `ability.cost_will`
- 적용 규칙:
  - 행동이 유효하게 제출되면 판정 결과와 무관하게 코스트 차감
  - 시스템 거부(권한/쿨타임/자원 부족/코스트 부족) 시 코스트 미차감

### defend / support 실효 규칙(초안)
- `defend`: 지정 아군이 이번 턴 받는 **첫 피해**에 `damage_factor = 0.5`
- `support`: 지정 아군의 이번 턴 **첫 공격**에 `multiplier +0.25` (상한 `1.0`)
- 두 효과 모두 1턴 1회성 토큰으로 처리(중첩 없음)

## 5. 단계별 구현 계획

### Phase A — 룰 고정
- 판정 등급/배수/기본 데미지 표 확정
- 엣지 케이스 규칙 확정(코스트 선차감, 0 클램프, 동시 반영, 롤백)
- 완료 기준: 룰 문서 1개로 수동 계산 재현 가능

### Phase B — 계약 정리
- 입력/출력 payload 계약 확정
- Input 단계 코스트 부족 검증 타이밍을 계약에 명시
- 상태 전이(`a_submitted -> b_submitted -> locked -> judged -> executed -> narrated`) 허용 규칙 확정
- 완료 기준: 프론트/백엔드 동시 개발 가능한 계약 문서 확보

### Phase C — 검증 시나리오
- 정상 5개 + 경계 5개 시나리오 작성
- 각 시나리오 기대 결과 수치 명시
- 완료 기준: 회귀 테스트용 기준표 완성

### Phase D — 관측 가능성
- encounter 단위 로그 표준화
- 실패 원인 분류 코드 정의
- 완료 기준: 장애 시 원인 역추적 가능한 로그 포맷 확보

### Phase E — 단계적 릴리스
- 내부 테스트 -> 소규모 베타 -> 전체 적용
- 롤백 기준(오류율/재시도율 임계치) 사전 정의
- 완료 기준: 배포/롤백 체크리스트 완성

## 6. 위험요소 및 대응

| 위험 | 영향 | 대응 |
|---|---|---|
| 판정 JSON 변형/오염 | 잘못된 계산 반영 | 서버측 화이트리스트 검증 |
| 중복 실행 | 데미지 2중 반영 | idempotency key 도입 |
| 협의 단계 경합/중복 제출 | 턴 상태 꼬임 | 상태 전이 검증 + idempotency key |
| 서사-수치 불일치 | 신뢰도 저하 | narration 입력을 execution 결과로 고정 |
| 코스트/데미지 처리 순서 오류 | 자원 불일치, 밸런스 붕괴 | 실행 순서 불변식 고정(코스트 선차감 후 데미지 계산) |

## 7. 완료 정의 (Definition of Done)
- 룰 표와 계약 문서가 확정되어 리뷰 승인됨
- 시나리오 10개 기대 결과가 문서화됨
- 실행/로그/롤백 기준이 운영 문서로 정리됨
- 베타 적용 전 체크리스트가 준비됨

## 8. 2:2 단체전 확장 구조 (추가안)

### 8-1. 확장 원칙
- 기존 1:1 심플 규칙을 유지한다.
- 단체전은 **참가자 수와 타겟 규칙만 확장**한다.
- 계산식(`base_damage * multiplier`)은 그대로 사용한다.

### 8-2. 참가자 모델 확장
- 기존: 양측 1명 고정
- 확장: 팀당 N명(초기 목표 2:2)
- 각 참가자는 독립 행동 선언 1개를 가진다.

운영 규칙:
- 한 턴에 각 참가자는 `action_type` 1개만 제출
- 미제출자는 해당 턴 `Fail`로 처리

### 8-3. 타겟 모델 확장
- 기존: 단일 타겟 중심
- 확장: 액션별 다중 타겟 허용

규칙:
- `attack`: 기본 단일 타겟
- `disrupt`: 단일 또는 다중 타겟 가능
- `support/defend`: 아군 1인 또는 팀 전체 버프(초기엔 1인 권장)

### 8-4. 집중 타격(Focus Fire) 감쇠 규칙
- 같은 턴에 2인이 동일 적 1인을 타격하면 2번째 타격부터 감쇠 적용
- 초기 감쇠안:
  - 첫 번째 타격: `100%`
  - 두 번째 타격: `80%`

계산:
`final_damage = floor(base_damage * multiplier * focus_factor)`

### 8-5. 2:2 비동시 협의 규칙
- 2:2도 **팀 A 선언 -> 팀 B 선언 -> 양팀 lock -> 연산/반영** 순서 유지
- 한 턴의 모든 stat change를 단일 트랜잭션으로 반영
- 중간 실패 시 전체 롤백
- 적용 순서 불변식:
  1) 유효성 검증
  2) 코스트 선차감
  3) 판정 multiplier 반영
  4) 데미지/감쇠/지원 보정 적용
  5) 최종 stat 반영

### 8-6. 승리 조건 확장
- 기본(섬멸형): 한 팀 전원 `HP = 0`이면 패배
- 목표형(확장 예정): 지정된 `RESOURCE`/목표 상태 달성 시 승리

초기 릴리스는 섬멸형만 활성화하고 목표형은 플래그로 비활성 유지

### 8-7. 2:2 전용 검증 시나리오 추가
- 양팀 1명씩 교차 공격(기본)
- 2인 집중 타격 감쇠 적용
- 한 명은 defend, 한 명은 attack 혼합
- 양측 동시 0 도달(무승부 규칙 확인)
- 1인 미제출(Fail 처리) + 팀원 단독 수행

완료 기준:
- 위 5개 시나리오의 기대 수치 결과가 문서화되고 테스트 기준으로 고정됨
